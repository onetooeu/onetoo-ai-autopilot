name: Release (zip + sha256 + minisign)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps + test
        run: |
          set -euo pipefail
          npm ci
          npm run ci
          npm run worker:smoke

      - name: Install minisign
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y minisign

      - name: Build release zip (git archive)
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          ZIP="onetoo-ai-autopilot-${TAG}.zip"
          git archive --format=zip --output "$ZIP" "$TAG"
          sha256sum "$ZIP" > "${ZIP}.sha256"
          echo "ZIP=$ZIP" >> "$GITHUB_ENV"

      - name: Import minisign secret key (whitespace-safe)
        env:
          MINISIGN_SECRET_B64: ${{ secrets.MINISIGN_SECRET_B64 }}
        run: |
          set -euo pipefail
          if [ -z "${MINISIGN_SECRET_B64:-}" ]; then
            echo "ERROR: MINISIGN_SECRET_B64 secret is empty or missing."
            exit 1
          fi

          # odstráň whitespace, keby GitHub UI niečo zalomil
          CLEANED="$(printf '%s' "$MINISIGN_SECRET_B64" | tr -d '\n\r\t ')"

          # dekóduj secret key
          printf '%s' "$CLEANED" | base64 -d > minisign.key
          chmod 600 minisign.key

          # sanity check (musí byť 2 riadky)
          LINES="$(wc -l < minisign.key | tr -d ' ')"
          if [ "$LINES" != "2" ]; then
            echo "ERROR: minisign.key should have 2 lines, got $LINES"
            echo "--- minisign.key (redacted lengths) ---"
            awk '{print NR ": len=" length($0)}' minisign.key
            exit 1
          fi

      - name: Sign (zip + sha256) (stdin password)
        env:
          MINISIGN_PASSWORD: ${{ secrets.MINISIGN_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${MINISIGN_PASSWORD:-}" ]; then
            echo "ERROR: MINISIGN_PASSWORD secret is empty or missing."
            exit 1
          fi

          printf '%s\n' "$MINISIGN_PASSWORD" | minisign -Sm "${ZIP}" -s minisign.key
          printf '%s\n' "$MINISIGN_PASSWORD" | minisign -Sm "${ZIP}.sha256" -s minisign.key

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.ZIP }}
            ${{ env.ZIP }}.sha256
            ${{ env.ZIP }}.minisig
            ${{ env.ZIP }}.sha256.minisig
