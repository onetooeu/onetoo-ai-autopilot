name: Release (zip + sha256 + minisign)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps + test
        run: |
          npm ci
          npm run ci
          npm run worker:smoke

      - name: Install minisign
        run: |
          sudo apt-get update
          sudo apt-get install -y minisign

      - name: Build release zip (git archive)
        run: |
          TAG="${GITHUB_REF_NAME}"
          ZIP="onetoo-ai-autopilot-${TAG}.zip"
          git archive --format=zip --output "$ZIP" "$TAG"
          sha256sum "$ZIP" > "${ZIP}.sha256"
          echo "ZIP=$ZIP" >> $GITHUB_ENV

      - name: Import minisign secret key
        env:
          MINISIGN_SECRET_B64: ${{ secrets.MINISIGN_SECRET_B64 }}
        run: |
          echo "$MINISIGN_SECRET_B64" | base64 -d > minisign.key
          chmod 600 minisign.key

      - name: Sign
        env:
          MINISIGN_PASSWORD: ${{ secrets.MINISIGN_PASSWORD }}
        run: |
          minisign -Sm "$ZIP" -s minisign.key -P "$MINISIGN_PASSWORD"
          minisign -Sm "${ZIP}.sha256" -s minisign.key -P "$MINISIGN_PASSWORD"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.ZIP }}
            ${{ env.ZIP }}.sha256
            ${{ env.ZIP }}.minisig
            ${{ env.ZIP }}.sha256.minisig
